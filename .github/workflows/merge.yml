name: Build Plugin File
on:
  push:
    branches: [ master ]
  schedule:
    - cron: '38 5 * * 4'
  workflow_dispatch:

jobs:
  build_file:
    name: build unified plugin file
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out the repo
        uses: actions/checkout@v6
      - name: setup python
        uses: actions/setup-python@v6
        with:
          python-version: 3.13
      - name: Run script
        uses: jannekem/run-python-script-action@v1
        with:
          script: |
            import os
            import json
            import urllib.request
            import urllib.parse
            import ssl

            plugins_dir = "plugins"
            output_file = "master_plugin_list.json"

            # Create SSL context for HTTPS requests
            ssl_context = ssl.create_default_context()

            def fetch_json(url: str) -> dict | None:
                try:
                    req = urllib.request.Request(
                        url,
                        headers={"User-Agent": "plugin-builder-action"}
                    )
                    with urllib.request.urlopen(req, context=ssl_context, timeout=10) as resp:
                        return json.loads(resp.read().decode("utf-8"))
                except Exception:
                    return None

            def get_github_stars(url: str) -> str:
                try:
                    parsed = urllib.parse.urlparse(url)
                    parts = parsed.path.strip("/").split("/")
                    if len(parts) < 2:
                        return ""
                    owner, repo = parts[0], parts[1]
                    api_url = f"https://api.github.com/repos/{owner}/{repo}"
                    data = fetch_json(api_url)
                    if data and "stargazers_count" in data:
                        return str(data["stargazers_count"])
                except Exception:
                    pass
                return ""

            def get_gitlab_stars(url: str) -> str:
                try:
                    parsed = urllib.parse.urlparse(url)
                    project_path = parsed.path.strip("/")
                    if not project_path:
                        return ""
                    encoded = urllib.parse.quote_plus(project_path)
                    api_url = f"https://gitlab.com/api/v4/projects/{encoded}"
                    data = fetch_json(api_url)
                    if data and "star_count" in data:
                        return str(data["star_count"])
                except Exception:
                    pass
                return ""

            plugins = []

            for entry in sorted(os.scandir(plugins_dir), key=lambda e: e.name):
                if not entry.is_file() or not entry.name.lower().endswith(".json"):
                    continue

                with open(entry.path, "r", encoding="utf-8") as f:
                    plugin = json.load(f)

                plugin_stars = ""
                main_link = plugin.get("pluginMainLink", "")

                if isinstance(main_link, str):
                    if "github.com" in main_link.lower():
                        plugin_stars = get_github_stars(main_link)
                    elif "gitlab.com" in main_link.lower():
                        plugin_stars = get_gitlab_stars(main_link)

                plugin["pluginStars"] = plugin_stars
                plugins.append(plugin)

            with open(output_file, "w", encoding="utf-8") as out:
                json.dump(plugins, out, indent=2, ensure_ascii=False)

            print(f"Wrote {len(plugins)} plugins to {output_file}")
      - name: push file to main
        uses: EndBug/add-and-commit@v9
        with:
          add: 'master_plugin_list.json'
          default_author: github_actor
          message: 'Update unified plugin file'
          push: true
